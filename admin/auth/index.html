<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Authenticating...</title>
  <script>
    // GitHub OAuth implicit flow handler for Decap CMS
    (function() {
      function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      function receiveMessage(e) {
        console.log("receiveMessage", e);
        if (e.origin !== "https://harryluoo.github.io") return;
        if (e.data === "authorizing:github") {
          window.postMessage("authorizing:github", "*");
          return;
        }
        if (e.data.indexOf("authorization:github:success:") === 0) {
          // Send the token back to the CMS
          window.opener.postMessage(e.data, "https://harryluoo.github.io");
          window.close();
        }
      }

      window.addEventListener("message", receiveMessage, false);
      
      // Handle the OAuth callback
      var code = getParameterByName('code');
      if (code) {
        // Redirect to GitHub OAuth with the authorization code
        var state = getParameterByName('state');
        var githubAuthUrl = 'https://github.com/login/oauth/authorize?' +
          'client_id=Ov23liYCESmcHxV5idBP&' +
          'redirect_uri=' + encodeURIComponent(window.location.origin + window.location.pathname) + '&' +
          'scope=repo,user&' +
          'state=' + encodeURIComponent(state);
        
        window.location.href = githubAuthUrl;
      }
    })();
  </script>
</head>
<body>
  <p>Authenticating with GitHub...</p>
</body>
</html>
