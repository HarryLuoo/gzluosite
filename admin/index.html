<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
  <style>
    :root {
      color-scheme: light;
    }

    body.pat-body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f6f8fa;
      color: #24292f;
    }

    a {
      color: #0969da;
    }

    code {
      background: #f1f4f8;
      padding: 0.1rem 0.25rem;
      border-radius: 0.35rem;
      font-size: 0.875rem;
    }

    .pat-auth-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2.5rem;
      min-height: 100vh;
      padding: 3rem 1rem 4rem;
      box-sizing: border-box;
    }

    .pat-auth-wrapper section {
      height: auto !important;
      max-width: min(440px, 100%);
      width: min(440px, 100%);
    }

    .pat-card {
      background: #fff;
      border: 1px solid #d0d7de;
      border-radius: 0.75rem;
      box-shadow: 0 18px 48px rgba(31, 35, 40, 0.08);
      padding: 1.75rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .pat-card h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    .pat-card ol {
      margin: 0;
      padding-left: 1.3rem;
      line-height: 1.5;
      color: #57606a;
    }

    .pat-card li + li {
      margin-top: 0.35rem;
    }

    .pat-form {
      display: grid;
      gap: 0.75rem;
    }

    .pat-form label {
      font-weight: 600;
      color: #1f2328;
    }

    .pat-form input {
      border: 1px solid #afb8c1;
      border-radius: 0.5rem;
      font-size: 1rem;
      padding: 0.65rem 0.75rem;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .pat-form input:focus {
      outline: none;
      border-color: #0969da;
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.25);
    }

    .pat-form button {
      appearance: none;
      border: none;
      border-radius: 0.55rem;
      background: #0969da;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.7rem 1rem;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .pat-form button:hover:not([disabled]) {
      background: #0757b2;
      transform: translateY(-1px);
    }

    .pat-form button[disabled] {
      background: #96b7ea;
      cursor: progress;
    }

    .pat-error {
      margin: 0;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      background: #fee2e2;
      color: #d1242f;
      font-weight: 600;
    }

    .pat-footnote {
      margin: 0;
      font-size: 0.85rem;
      color: #57606a;
      line-height: 1.4;
    }

    @media (max-width: 520px) {
      .pat-auth-wrapper {
        padding: 2rem 1rem 3rem;
      }
    }
  </style>
  <script>
    window.CMS_MANUAL_INIT = true;
  </script>
</head>
<body class="pat-body">
  <noscript>You need to enable JavaScript to run the content manager.</noscript>

  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    (function () {
      function initializeCms() {
        var CMS = window.CMS;

        if (!CMS) {
          console.error('Decap CMS failed to expose the CMS global.');
          return;
        }

        var React = CMS.React || window.React;
        if (!React) {
          console.error('React was not exposed by Decap CMS; falling back to the default login UI.');
          CMS.init({ config: { load_config_file: true } });
          return;
        }

        var backendEntry = CMS.getBackend('github');
        if (!backendEntry || typeof backendEntry.init !== 'function') {
          console.error('Decap CMS GitHub backend could not be located.');
          CMS.init({ config: { load_config_file: true } });
          return;
        }

        if (!backendEntry.__patWrapped) {
          var originalInit = backendEntry.init;

          backendEntry.init = function init(config, options) {
            return Promise.resolve(originalInit.call(this, config, options)).then(function (backend) {
              if (!backend || typeof backend.authComponent !== 'function') {
                return backend;
              }

              var originalAuthComponent = backend.authComponent.bind(backend);

              backend.authComponent = function authComponent() {
                var OriginalComponent = originalAuthComponent();

                var useState = React.useState;
                var useRef = React.useRef;
                var useEffect = React.useEffect;

                function TokenCard(props) {
                  var onLogin = props.onLogin;
                  var disabled = props.inProgress;
                  var _useState = useState('');
                  var token = _useState[0];
                  var setToken = _useState[1];
                  var _useState2 = useState(false);
                  var submitting = _useState2[0];
                  var setSubmitting = _useState2[1];
                  var _useState3 = useState('');
                  var error = _useState3[0];
                  var setError = _useState3[1];
                  var inputRef = useRef(null);

                  useEffect(function () {
                    if (inputRef.current) {
                      inputRef.current.focus();
                    }
                  }, []);

                  function handleSubmit(event) {
                    event.preventDefault();
                    var trimmed = token.trim();
                    if (!trimmed) {
                      setError('Paste the token you generated on GitHub.');
                      return;
                    }

                    setSubmitting(true);
                    setError('');

                    try {
                      Promise.resolve(onLogin({ token: trimmed })).catch(function (err) {
                        console.error('Token login failed:', err);
                        var message =
                          (err && err.message) ||
                          (err && err.toString && err.toString()) ||
                          'Unable to log in with that token.';
                        setError(message);
                        setSubmitting(false);
                      });
                    } catch (err) {
                      console.error('Token login failed:', err);
                      var fallback =
                        (err && err.message) ||
                        (err && err.toString && err.toString()) ||
                        'Unable to log in with that token.';
                      setError(fallback);
                      setSubmitting(false);
                    }
                  }

                  return React.createElement(
                    'section',
                    { className: 'pat-card', 'aria-live': 'polite' },
                    React.createElement('h2', null, 'Use a personal access token'),
                    React.createElement(
                      'p',
                      null,
                      'Generate a classic token with ',
                      React.createElement('code', null, 'repo'),
                      ' scope and paste it below to edit this site.'
                    ),
                    React.createElement(
                      'ol',
                      null,
                      React.createElement(
                        'li',
                        null,
                        React.createElement(
                          'a',
                          {
                            href: 'https://github.com/settings/tokens',
                            target: '_blank',
                            rel: 'noopener noreferrer',
                          },
                          'Open GitHub’s token settings'
                        )
                      ),
                      React.createElement(
                        'li',
                        null,
                        'Create a classic token that includes the ',
                        React.createElement('code', null, 'repo'),
                        ' scope.'
                      ),
                      React.createElement(
                        'li',
                        null,
                        'Paste the token into the field below and sign in.'
                      )
                    ),
                    error ? React.createElement('p', { className: 'pat-error' }, error) : null,
                    React.createElement(
                      'form',
                      { className: 'pat-form', onSubmit: handleSubmit },
                      React.createElement(
                        'label',
                        { htmlFor: 'pat-input' },
                        'GitHub personal access token'
                      ),
                      React.createElement('input', {
                        id: 'pat-input',
                        ref: inputRef,
                        type: 'password',
                        autoComplete: 'off',
                        inputMode: 'text',
                        placeholder: 'ghp_XXXXXXXXXXXXXXXXXXXX',
                        value: token,
                        onChange: function onChange(event) {
                          setToken(event.target.value);
                        },
                        disabled: disabled || submitting,
                        required: true,
                      }),
                      React.createElement(
                        'button',
                        { type: 'submit', disabled: disabled || submitting },
                        disabled || submitting ? 'Signing in…' : 'Log in with token'
                      ),
                      React.createElement(
                        'p',
                        { className: 'pat-footnote' },
                        'Keep the token in a password manager and revoke it from GitHub if it is ever exposed.'
                      )
                    )
                  );
                }

                function WrappedAuth(props) {
                  return React.createElement(
                    'div',
                    { className: 'pat-auth-wrapper' },
                    OriginalComponent ? React.createElement(OriginalComponent, props) : null,
                    React.createElement(TokenCard, props)
                  );
                }

                return WrappedAuth;
              };

              return backend;
            });
          };

          backendEntry.__patWrapped = true;
        }
        CMS.init({ config: { load_config_file: true } });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeCms);
      } else {
        initializeCms();
      }
    })();
  </script>

  <script>
    // Custom backend integration for local development
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      console.log('Custom backend integration initializing...');

      // Override fetch to intercept all CMS operations
      const originalFetch = window.fetch;
      window.fetch = function (...args) {
        const [url, options = {}] = args;

        // Log all fetch requests for debugging
        console.log('Fetch intercepted:', {
          url: url,
          method: options.method || 'GET',
          hasBody: !!options.body,
        });

        // Handle test-repo backend operations
        if (typeof url === 'string') {
          // Intercept GitHub API-style requests (for saving)
          if (options.method === 'PUT' && url.includes('contents/')) {
            console.log('Intercepting GitHub-style save operation');

            // Extract file path from URL
            const urlParts = url.split('contents/');
            const filePath = decodeURIComponent(urlParts[1] || '');

            // Parse the content
            let content = '';
            try {
              const body = JSON.parse(options.body || '{}');
              content = body.content ? atob(body.content) : '';
            } catch (e) {
              console.error('Error parsing body:', e);
            }

            // Send to our backend
            return fetch('http://localhost:8081/api/save', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                path: filePath,
                content: content,
              }),
            })
              .then(response => {
                if (response.ok) {
                  // Return a fake success response that CMS expects
                  return new Response(
                    JSON.stringify({
                      content: {
                        path: filePath,
                        name: filePath.split('/').pop(),
                        sha: Date.now().toString(),
                      },
                      commit: {
                        sha: Date.now().toString(),
                        message: 'Update ' + filePath,
                      },
                    }),
                    {
                      status: 200,
                      headers: { 'Content-Type': 'application/json' },
                    }
                  );
                }
                throw new Error('Save failed');
              })
              .catch(err => {
                console.error('Backend save error:', err);
                throw err;
              });
          }

          // Intercept test-repo specific endpoints
          if (url.includes('/__test-repo__/')) {
            console.log('Intercepting test-repo operation:', url);

            // Handle different test-repo endpoints
            if (options.method === 'POST' && url.endsWith('/save')) {
              // This is a save operation in test-repo mode
              let body;
              try {
                body = JSON.parse(options.body || '{}');
              } catch (e) {
                console.error('Error parsing test-repo body:', e);
                body = {};
              }

              // Extract file information
              const filePath = body.path || body.file || '';
              const content = body.content || body.raw || '';

              console.log('Test-repo save:', { filePath, contentLength: content.length });

              // Send to our backend
              return fetch('http://localhost:8081/api/save', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  path: filePath,
                  content: content,
                }),
              })
                .then(response => response.json())
                .then(data => {
                  // Return success in test-repo format
                  return new Response(
                    JSON.stringify({
                      success: true,
                      ...data,
                    }),
                    {
                      status: 200,
                      headers: { 'Content-Type': 'application/json' },
                    }
                  );
                })
                .catch(err => {
                  console.error('Backend save error:', err);
                  throw err;
                });
            }

            // Handle file listing requests
            if (url.includes('/files') || url.includes('/entries')) {
              return fetch('http://localhost:8081/api/files')
                .then(response => response.json())
                .then(data => {
                  return new Response(JSON.stringify(data), {
                    status: 200,
                    headers: { 'Content-Type': 'application/json' },
                  });
                });
            }

            // Handle file reading requests
            if (options.method === 'GET' && (url.includes('/file/') || url.includes('/entry/'))) {
              const pathMatch = url.match(/\/(file|entry)\/(.+)$/);
              if (pathMatch) {
                const filePath = decodeURIComponent(pathMatch[2]);
                return fetch(`http://localhost:8081/api/file?path=${encodeURIComponent(filePath)}`)
                  .then(response => response.json())
                  .then(data => {
                    return new Response(JSON.stringify(data), {
                      status: 200,
                      headers: { 'Content-Type': 'application/json' },
                    });
                  });
              }
            }
          }

          // Intercept local storage operations (another test-repo pattern)
          if (url.startsWith('blob:') || (url.includes('localhost') && options.method === 'POST')) {
            if (options.body) {
              let body;
              try {
                if (typeof options.body === 'string') {
                  body = JSON.parse(options.body);
                } else if (options.body instanceof FormData) {
                  console.log('FormData detected, may need special handling');
                }

                if (body && (body.path || body.slug) && body.body) {
                  console.log('Detected CMS save via local pattern');
                  const filePath = body.path || `_posts/${body.slug}.md`;
                  const content = body.body || '';

                  return fetch('http://localhost:8081/api/save', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                      path: filePath,
                      content: content,
                    }),
                  }).then(response => {
                    if (response.ok) {
                      return response.json().then(data => {
                        return new Response(
                          JSON.stringify({
                            success: true,
                            ...body,
                            ...data,
                          }),
                          {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' },
                          }
                        );
                      });
                    }
                    throw new Error('Save failed');
                  });
                }
              } catch (e) {
                // Not JSON, continue with normal fetch
              }
            }
          }
        }

        return originalFetch.apply(this, args);
      };

      // Additional hook for CMS initialization
      window.addEventListener('load', function () {
        console.log('Page loaded, CMS backend hooks active');

        // Monitor localStorage changes (test-repo uses localStorage)
        const originalSetItem = localStorage.setItem;
        localStorage.setItem = function (key, value) {
          console.log('LocalStorage set:', key, value ? value.substring(0, 100) + '...' : 'null');

          // Check if it's a post being saved
          if (key && key.includes('posts/') && value) {
            try {
              const data = JSON.parse(value);
              if (data.slug && data.body) {
                console.log('Detected post save in localStorage');

                const date = new Date().toISOString().split('T')[0];
                const filename = `_posts/${date}-${data.slug}.md`;

                let content = '---\n';
                content += `layout: ${data.layout || 'post'}\n`;
                content += `title: "${data.title || data.slug}"\n`;
                if (data.date) content += `date: ${data.date}\n`;
                if (data.categories)
                  content += `categories: ${Array.isArray(data.categories) ? data.categories.join(' ') : data.categories}\n`;
                if (data.tags) content += `tags: ${Array.isArray(data.tags) ? data.tags.join(' ') : data.tags}\n`;
                content += '---\n\n';
                content += data.body || '';

                fetch('http://localhost:8081/api/save', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    path: filename,
                    content: content,
                  }),
                })
                  .then(response => response.json())
                  .then(data => {
                    console.log('Post saved to filesystem:', data);
                  })
                  .catch(err => {
                    console.error('Failed to save post:', err);
                  });
              }
            } catch (e) {
              // Not post data, ignore
            }
          }

          return originalSetItem.apply(this, arguments);
        };
      });
    }
  </script>
</body>
</html>
